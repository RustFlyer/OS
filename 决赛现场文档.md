# Nighthawk OS 决赛现场赛总结

截至现场赛验收结束，Nighthawk OS 共获得 190 分，排名第 6 。

<div align="center">
  <img src="./assets/onsite_leaderboard.png" alt="Nighthawk现场赛排名" width="800"/>
</div>

## vim

### Qemu
vim 在 RISC-V 架构的 Qemu 上能够流畅运行。在 LoongArch 架构的 Qemu 上，由于中断支持不足，运行较为缓慢，但能顺利完成文本编辑功能。最终两个架构的 Nighthawk OS 在 Qemu 上都顺利通过所有相关决赛测例。

调试细节：
1.  `vim -h` 命令顺利通过。
2.  `vim <file>` 功能因内核事先已支持设备中断及完善的 tty 设置而顺利通过。但在 vim 退出时出现卡住问题，经检查发现是 `exit_group` 执行后有子进程未被唤醒。通过在 `exit_group` 时唤醒沉睡的进程解决了该问题。

### 开发版
vim 在 RISC-V 架构的开发版上流畅运行，但 LoongArch 开发版尚未实现相关支持。

## git

### Qemu
在 Qemu 上能够顺利使用本地版本管理的各项功能，但在适配 `git log` 指令时发现，git pager 默认使用 `less` 工具。由于内核驱动未实现对 `termios` 的支持，通过以下指令将工具改为 `cat` 后顺利实现。


git config --global core.pager "cat"
在线功能由于网络支持的漏洞而无法正常使用。git clone https 时出现无法识别的 https 错误，git daemon 也发生无法找到文件的错误（但直接运行 /../git-daemon 则有效），原因暂时未知。

调试细节：

修复了 git add . 发生的错误。该问题是由于在 rename 底层误用 unlink 处理，导致 rename 双方因 ino 序号相同而被认定为 link 关系，从而引发 "fatal: not git" 错误。修正底层处理后通过。

### 开发版
在 RISC-V 开发版上顺利实现本地 git 功能，但 LoongArch 开发版尚未实现相关支持。

## gcc

### Qemu
Nighthawk OS 能够使用 gcc 顺利编译简易贪吃蛇程序的 C 语言源码，并取得了 Qemu 题目的满分。此外，gcc 也可以顺利生成编译中间产物（如 gcc -S 等命令）。

调试细节：

gcc -h 命令顺利输出。

gcc hello.c && ./a.out 能够顺利执行并输出。需要注意的是，该指令需要分开执行，或使用 busybox sh -c "gcc hello.c && ./a.out" 来识别 && 符号。

### 开发版
RISC-V 开发版也已经同步实现打印简介和编译 C 源码的功能，但没能在 LoongArch 开发版上实现 C 程序编译。

## rustc

### Qemu
通过对管道读取功能的排查修复，Nighthawk OS 在现场赛实现了两个架构下 rustc 的打印简介功能。

调试细节：

rustc -h 执行时卡住的问题，是由于有进程被 kill 时陷在 pipe read 中。通过完善机制，在检测到进程死亡时强制退出，成功通过该项测试。

在 RISC-V 上，rustc 编译文件时卡死，发现是使用了不带 bit 的旧版 futex (Wait 和 Wake) 机制，改回旧版后编译完成，但随后发生 panic 并出现超长 backtrace，因时间原因未能完成调试。

### 开发版

文档中未提供 rustc 在开发版上的通过情况。

## 其他问题

龙芯（LoongArch）的开发版存在内存问题，总是传输错误的参数，该问题一直未能排查出来。